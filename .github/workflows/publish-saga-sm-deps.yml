name: Publish Saga-SM Dependencies

# Focused workflow to publish only the packages that saga-sm depends on
# This ensures saga-sm CI/CD can install these packages from GitHub Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      force_publish:
        description: "Force publish even if tests fail"
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - "packages/api-core/**"
      - "packages/config/**"
      - "packages/db/**"
      - "packages/logger/**"
      - "packages/pubsub-core/**"
      - "packages/trpc-codegen/**"
      - "build-tools/zod2ts/**"

env:
  NODE_VERSION: "20"

# Security permissions
permissions:
  id-token: write
  contents: write
  packages: write

jobs:
  prepare:
    name: ðŸ“‹ Prepare Saga-SM Dependencies
    runs-on: ubuntu-latest
    outputs:
      saga-sm-packages: ${{ steps.define-packages.outputs.packages }}
      build-tools: ${{ steps.define-packages.outputs.build-tools }}
    steps:
      - name: ðŸ“¦ Define target packages
        id: define-packages
        run: |
          # Define the exact packages saga-sm depends on
          SAGA_SM_PACKAGES='["api-core", "config", "db", "logger", "pubsub-core", "trpc-codegen"]'
          BUILD_TOOLS='["zod2ts"]'
          
          echo "packages=$SAGA_SM_PACKAGES" >> $GITHUB_OUTPUT
          echo "build-tools=$BUILD_TOOLS" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Target packages: $SAGA_SM_PACKAGES"
          echo "ðŸ”§ Build tools: $BUILD_TOOLS"

  test-saga-sm-packages:
    name: ðŸ§ª Test Saga-SM Dependencies
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare.outputs.saga-sm-packages) }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ“¦ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§¹ Lint ${{ matrix.package }}
        run: pnpm turbo run lint --filter=@hipponot/${{ matrix.package }}

      - name: ðŸ” Type check ${{ matrix.package }}
        run: pnpm turbo run check-types --filter=@hipponot/${{ matrix.package }}

      - name: ðŸ—ï¸ Build ${{ matrix.package }}
        run: pnpm turbo run build --filter=@hipponot/${{ matrix.package }}...

      - name: ðŸ§ª Test ${{ matrix.package }}
        run: pnpm turbo run test --filter=@hipponot/${{ matrix.package }}

  test-build-tools:
    name: ðŸ”§ Test Build Tools
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        tool: ${{ fromJson(needs.prepare.outputs.build-tools) }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ“¦ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build ${{ matrix.tool }}
        run: |
          cd build-tools/${{ matrix.tool }}
          pnpm build

  publish-saga-sm-deps:
    name: ðŸ“¤ Publish Saga-SM Dependencies
    runs-on: ubuntu-latest
    needs: [prepare, test-saga-sm-packages, test-build-tools]
    if: |
      always() && 
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      (
        needs.test-saga-sm-packages.result == 'success' || 
        github.event.inputs.force_publish == 'true'
      )
    outputs:
      published-packages: ${{ steps.publish.outputs.published-packages }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://npm.pkg.github.com"
          scope: "@hipponot"

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ðŸ“¦ Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ“¦ Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build all packages
        run: pnpm turbo run build

      - name: ðŸ”§ Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: â¬†ï¸ Version bump packages
        if: github.event_name == 'workflow_dispatch'
        run: |
          PACKAGES='${{ needs.prepare.outputs.saga-sm-packages }}'
          BUILD_TOOLS='${{ needs.prepare.outputs.build-tools }}'
          VERSION_TYPE="${{ github.event.inputs.version }}"
          
          echo "ðŸ“ˆ Bumping $VERSION_TYPE version for saga-sm dependencies"
          
          # Bump saga-sm runtime dependencies
          echo "$PACKAGES" | jq -r '.[]' | while read -r package; do
            if [ -n "$package" ]; then
              echo "ðŸ“¦ Bumping packages/$package"
              cd "packages/$package"
              npm version "$VERSION_TYPE" --no-git-tag-version
              cd ../..
            fi
          done
          
          # Bump build tools
          echo "$BUILD_TOOLS" | jq -r '.[]' | while read -r tool; do
            if [ -n "$tool" ]; then
              echo "ðŸ”§ Bumping build-tools/$tool"
              cd "build-tools/$tool"
              npm version "$VERSION_TYPE" --no-git-tag-version
              cd ../..
            fi
          done

          # Commit version changes
          git add packages/*/package.json build-tools/*/package.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No version changes to commit"
          else
            git commit -m "chore: bump saga-sm dependency versions ($VERSION_TYPE)"
            git push
          fi

      - name: ðŸ“ Setup .npmrc for GitHub Packages
        run: |
          echo "@hipponot:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: ðŸ“¤ Publish packages in dependency order
        id: publish
        run: |
          PACKAGES='${{ needs.prepare.outputs.saga-sm-packages }}'
          BUILD_TOOLS='${{ needs.prepare.outputs.build-tools }}'
          PUBLISHED_PACKAGES=()
          
          # Function to publish a package
          publish_package() {
            local package_dir="$1"
            local package_name="$2"
            local package_type="$3"
            
            if [ -f "$package_dir/package.json" ]; then
              local is_private=$(jq -r '.private // false' "$package_dir/package.json")
              if [ "$is_private" != "true" ]; then
                echo "ðŸ“¤ Publishing $package_name ($package_type)..."
                cd "$package_dir"
                
                if npm publish --access public; then
                  echo "âœ… Successfully published $package_name"
                  echo "$package_name" >> /tmp/published.txt
                else
                  echo "âš ï¸ Failed to publish $package_name (may already exist)"
                fi
                
                cd - > /dev/null
              else
                echo "â­ï¸ Skipping $package_name (private package)"
              fi
            fi
          }
          
          echo "" > /tmp/published.txt
          
          # Publish in dependency order (base packages first)
          # Layer 0: Base packages (no @hipponot dependencies)
          publish_package "packages/logger" "logger" "base"
          publish_package "packages/config" "config" "base"
          
          # Layer 1: Packages depending on base packages
          publish_package "packages/db" "db" "layer-1"
          publish_package "packages/pubsub-core" "pubsub-core" "layer-1"
          
          # Layer 2: Higher-level packages
          publish_package "packages/api-core" "api-core" "layer-2"
          
          # Build-time tools (can be published in parallel)
          publish_package "packages/trpc-codegen" "trpc-codegen" "dev-tool"
          publish_package "build-tools/zod2ts" "zod2ts" "build-tool"
          
          # Collect published packages
          if [ -f /tmp/published.txt ]; then
            PUBLISHED_JSON=$(cat /tmp/published.txt | grep -v '^$' | jq -R -s -c 'split("\n")[:-1]')
          else
            PUBLISHED_JSON="[]"
          fi
          
          echo "published-packages=$PUBLISHED_JSON" >> $GITHUB_OUTPUT
          echo "âœ… Published packages: $PUBLISHED_JSON"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-summary:
    name: ðŸ“‹ Create Release Summary
    runs-on: ubuntu-latest
    needs: [publish-saga-sm-deps]
    if: always() && needs.publish-saga-sm-deps.result == 'success'
    steps:
      - name: ðŸ“‹ Create summary
        run: |
          PUBLISHED='${{ needs.publish-saga-sm-deps.outputs.published-packages }}'
          
          echo "## ðŸŽ¯ Saga-SM Dependencies Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following packages are now available for saga-sm CI/CD:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$PUBLISHED" != "[]" ]; then
            echo "$PUBLISHED" | jq -r '.[]' | while read -r pkg; do
              if [ -n "$pkg" ]; then
                echo "- âœ… \`@hipponot/$pkg\`" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "- â„¹ï¸ No new packages published (all up to date)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Usage in saga-sm" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Configure npm for GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "npm config set @hipponot:registry https://npm.pkg.github.com" >> $GITHUB_STEP_SUMMARY
          echo "npm config set //npm.pkg.github.com/:_authToken \${GITHUB_TOKEN}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install in saga-sm" >> $GITHUB_STEP_SUMMARY
          echo "pnpm install" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY